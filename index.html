<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>本地电子书阅读器</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden; /* 禁止 body 出现滚动条 */
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                /* padding: 20px; */
                background-color: #f5f5f5;
                color: #333;
            }
            .container {
                display: flex;
                flex-direction: column;
                height: 100vh; /* 高度为视口高度 */
                box-sizing: border-box;
            }

            h1 {
                text-align: center;
                color: #2c3e50;
                margin-bottom: 30px;
            }
            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 20px;
                align-items: center;
                padding: 15px;
                background-color: #f0f0f0;
                border-radius: 5px;
                flex-shrink: 0;
            }
            .control-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            label {
                font-weight: bold;
                margin-right: 5px;
            }
            button,
            select,
            input[type="file"] {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: white;
                font-size: 14px;
            }
            button {
                background-color: #3498db;
                color: white;
                border: none;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #2980b9;
            }
            button:disabled {
                background-color: #95a5a6;
                cursor: not-allowed;
            }

            #reader {
                flex: 1;
                overflow: hidden; /* 禁止横向滚动，保留垂直滚动由内部控制 */
                display: flex;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: white;
                min-width: 0; /* 防止子元素撑宽 */
            }

            #toc {
                width: 250px;
                overflow-y: auto;
                overflow-x: hidden;
                box-sizing: border-box;
                min-width: 0;
            }

            #toc-list li {
                padding: 6px 8px;
                cursor: pointer;
                user-select: none;
                font-size: 14px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            #toc-list li.active {
                background-color: #3498db;
                color: white;
                font-weight: bold;
                border-radius: 4px;
            }

            #epub-viewer {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden; /* 禁止横向滚动条 */
                box-sizing: border-box;
            }
            #epub-viewer .epub-view {
                width: 100% !important;
            }

            .status {
                margin-top: 10px;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 4px;
                display: none;
            }
            .status.success {
                background-color: #d4edda;
                color: #155724;
                display: block;
            }
            .status.error {
                background-color: #f8d7da;
                color: #721c24;
                display: block;
            }
            .settings {
                flex-shrink: 0;
                padding: 15px;
                background-color: #f8f9fa;
                border-radius: 5px;
            }
            .settings h3 {
                margin: 5px 0;
            }
            .settings-row {
                display: flex;
                align-items: center;
                margin-right: 50px;
            }
            .settings-row:last-child {
                margin-right: 0;
            }
            .settings-row label {
                width: auto;
            }
            input[type="range"] {
                width: 200px;
                margin-right: 10px;
            }
            .font-preview {
                font-size: 1.2em;
                margin-top: 5px;
            }
            #speechControls {
                margin-top: 10px;
                padding: 10px;
                background-color: #fafafa;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .highlight {
                background-color: yellow !important;
                color: black !important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 style="display: none">本地电子书阅读器</h1>

            <div class="controls">
                <div class="control-group">
                    <label for="bookInput">选择图书:</label>
                    <input type="file" id="bookInput" accept=".txt,.epub" />
                </div>
                <div class="control-group">
                    <button id="loadFontsBtn">加载系统字体</button>
                    <select id="fontSelector" disabled>
                        <option value="">-- 选择字体 --</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="resetBtn">重置样式</button>
                </div>
            </div>

            <div class="controls" id="speechControls">
                <div class="control-group">
                    <button id="readBtn">🔊 开始朗读</button>
                    <button id="pauseBtn">⏸ 暂停</button>
                    <button id="resumeBtn">▶️ 继续</button>
                    <button id="stopBtn">⏹ 停止</button>
                </div>
                <div class="control-group">
                    <label for="voiceSelect">语音:</label>
                    <select id="voiceSelect"></select>
                </div>
                <div class="control-group">
                    <label for="rateRange">语速:</label>
                    <input
                        type="range"
                        id="rateRange"
                        min="0.5"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>
                <div class="control-group">
                    <label for="autoNextChapter">自动朗读下一章:</label>
                    <input type="checkbox" id="autoNextChapter" checked />
                </div>
            </div>

            <div class="settings">
                <h3>阅读设置</h3>
                <div style="display: flex">
                    <div class="settings-row">
                        <label for="fontSize">字体大小:</label>
                        <input
                            type="range"
                            id="fontSize"
                            min="12"
                            max="32"
                            value="16"
                            step="1"
                        />
                        <span id="fontSizeValue">16px</span>
                    </div>
                    <div class="settings-row">
                        <label for="lineHeight">行高:</label>
                        <input
                            type="range"
                            id="lineHeight"
                            min="1"
                            max="2.5"
                            value="1.6"
                            step="0.1"
                        />
                        <span id="lineHeightValue">1.6</span>
                    </div>
                    <div class="settings-row">
                        <label for="theme">主题:</label>
                        <select id="theme">
                            <option value="light">浅色</option>
                            <option value="dark">深色</option>
                            <option value="sepia">护眼</option>
                        </select>
                    </div>
                    <div class="settings-row" style="display: none">
                        <label>当前字体:</label>
                        <div id="currentFont" class="font-preview">
                            未选择字体
                        </div>
                    </div>
                </div>
            </div>

            <div id="status" class="status"></div>

            <div
                id="reader"
                style="
                    display: flex;
                    height: 70vh;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    overflow: hidden;
                "
            >
                <p
                    style="
                        text-align: center;
                        color: #777;
                        margin-top: 50px;
                        display: flex;
                        align-items: center;
                        flex: 1;
                        flex-direction: column;
                    "
                >
                    请选择本地图书文件开始阅读<br />支持格式: .txt, .epub
                </p>
            </div>
        </div>

        <script>
            const bookInput = document.getElementById("bookInput");
            const loadFontsBtn = document.getElementById("loadFontsBtn");
            const fontSelector = document.getElementById("fontSelector");
            const reader = document.getElementById("reader");
            const statusDiv = document.getElementById("status");
            const resetBtn = document.getElementById("resetBtn");
            const fontSizeSlider = document.getElementById("fontSize");
            const fontSizeValue = document.getElementById("fontSizeValue");
            const lineHeightSlider = document.getElementById("lineHeight");
            const lineHeightValue = document.getElementById("lineHeightValue");
            const themeSelect = document.getElementById("theme");
            const currentFontDisplay = document.getElementById("currentFont");

            const state = {
                currentFont: null,
                fontSize: 16,
                lineHeight: 1.6,
                theme: "light",
                isEpub: false, // 是否当前在阅读 epub
                isSpeaking: false, // 是否正在朗读
                currentSentence: null, // 当前朗读的句子
                autoNextChapter: true, // 自动朗读下一章
            };

            let rendition = null;
            let book = null;
            // 确保使用全局的 speechSynthesis 对象
            const mySpeechSynthesis = window.speechSynthesis;
            let speechUtterance = null;
            let currentChapterText = ""; // 当前章节文本
            let sentences = []; // 分割后的句子数组
            let currentSentenceIndex = 0; // 当前朗读的句子索引

            function init() {
                bookInput.addEventListener("change", handleFileSelect);
                loadFontsBtn.addEventListener("click", loadSystemFonts);
                fontSelector.addEventListener("change", applySelectedFont);
                resetBtn.addEventListener("click", resetStyles);
                fontSizeSlider.addEventListener("input", updateFontSize);
                lineHeightSlider.addEventListener("input", updateLineHeight);
                themeSelect.addEventListener("change", updateTheme);

                // 检查语音合成API是否可用
                if ('speechSynthesis' in window) {
                    console.log("语音合成API可用");
                    // 初始化语音合成相关事件
                    initSpeechSynthesis();
                    
                    // 绑定朗读按钮事件
                    document.getElementById("readBtn").addEventListener("click", function() {
                        console.log("开始朗读按钮被点击");
                        startReading();
                    });
                    document.getElementById("pauseBtn").addEventListener("click", pauseReading);
                    document.getElementById("resumeBtn").addEventListener("click", resumeReading);
                    document.getElementById("stopBtn").addEventListener("click", stopReading);
                    
                    // 语速调整
                    document.getElementById("rateRange").addEventListener("input", updateSpeechRate);
                } else {
                    console.error("语音合成API不可用");
                    showStatus("您的浏览器不支持语音合成功能", "error");
                    // 禁用朗读按钮
                    document.getElementById("readBtn").disabled = true;
                    document.getElementById("pauseBtn").disabled = true;
                    document.getElementById("resumeBtn").disabled = true;
                    document.getElementById("stopBtn").disabled = true;
                }
                
                // 自动朗读下一章控制
                document.getElementById("autoNextChapter").addEventListener("change", function(e) {
                    state.autoNextChapter = e.target.checked;
                });

                updateFontSize();
                updateLineHeight();
                updateTheme();
            }

            async function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                clearStatus();

                try {
                    if (file.name.endsWith(".txt")) {
                        state.isEpub = false;
                        if (rendition) {
                            rendition.destroy();
                            rendition = null;
                        }
                        book = null;

                        const text = await file.text();
                        displayTextContent(text);
                        showStatus(`成功加载: ${file.name}`, "success");
                    } else if (file.name.endsWith(".epub")) {
                        state.isEpub = true;
                        displayEpubContent(file);
                        showStatus(`成功加载: ${file.name}`, "success");
                    } else {
                        showStatus("不支持的文件格式", "error");
                    }
                } catch (error) {
                    showStatus(`读取失败: ${error.message}`, "error");
                    console.error("读取错误：", error);
                }
            }

            function displayTextContent(text) {
                console.log("显示文本内容，文本长度:", text.length);
                
                // 将文本分割成句子，用于朗读和高亮
                currentChapterText = text;
                sentences = splitTextIntoSentences(text);
                currentSentenceIndex = 0;
                
                console.log("准备渲染句子到HTML，句子数量:", sentences.length);
                
                // 为每个句子添加span标签，以便高亮
                let htmlContent = "";
                try {
                    sentences.forEach((sentence, index) => {
                        // 安全处理HTML特殊字符
                        const safeText = sentence
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;")
                            .replace(/\n/g, "<br>")
                            .replace(/ /g, "&nbsp;");
                            
                        htmlContent += `<span class="sentence" data-index="${index}">${safeText}</span>`;
                    });
                    
                    reader.innerHTML = `<div class="content">${htmlContent}</div>`;
                    console.log("文本内容渲染完成");
                    
                    // 检查是否成功创建了句子元素
                    const sentenceElements = document.querySelectorAll(".sentence");
                    console.log("创建的句子元素数量:", sentenceElements.length);
                    
                    applyCurrentSettings();
                } catch (error) {
                    console.error("渲染文本内容时出错:", error);
                    reader.innerHTML = `<div class="content"><p>渲染文本时出错: ${error.message}</p></div>`;
                    showStatus("渲染文本时出错: " + error.message, "error");
                }
            }

            function displayEpubContent(file) {
                reader.innerHTML = `
                    <div id="toc" style="width: 250px; overflow-y: auto; border-right: 1px solid #ddd; padding: 10px; box-sizing: border-box;"></div>
                    <div id="epub-viewer" style="flex: 1; overflow-x: auto; height: 100%;"></div>
                `;

                if (rendition) {
                    rendition.destroy();
                    rendition = null;
                }
                book = ePub();

                const readerInstance = new FileReader();

                readerInstance.onload = async function () {
                    try {
                        const arrayBuffer = readerInstance.result;
                        await book.open(arrayBuffer, "binary");

                        rendition = book.renderTo("epub-viewer", {
                            width: "100%",
                            height: "100%",
                            flow: "scrolled",
                            spread: "none",
                            allowScriptedContent: true,
                        });

                        window.rendition = rendition;

                        const start =
                            book.navigation?.toc?.[0]?.href || undefined;

                        await rendition.display(start);

                        generateToc(book.navigation.toc);

                        applyEpubTheme();

                        setupKeyboardListener();

                        renderToc(book.navigation.toc || []);

                        // 绑定章节变更事件，动态高亮目录
                        rendition.on("relocated", (location) => {
                            const currentHref = location.start.href.replace(
                                /#.*/,
                                ""
                            );

                            const tocItems =
                                document.querySelectorAll("#toc-list li");
                            tocItems.forEach((li) => {
                                const href = li.dataset.href?.replace(
                                    /#.*/,
                                    ""
                                );
                                if (href === currentHref) {
                                    li.classList.add("active");
                                    li.scrollIntoView({
                                        behavior: "smooth",
                                        block: "center",
                                    });
                                } else {
                                    li.classList.remove("active");
                                }
                            });
                        });

                        // 清理旧事件，避免多次绑定
                        document.removeEventListener("keydown", onKeyDown);
                        document.addEventListener("keydown", onKeyDown);

                        // 添加点击左右区域翻页支持
                        const epubViewer =
                            document.getElementById("epub-viewer");
                        epubViewer.onclick = (e) => {
                            const rect = epubViewer.getBoundingClientRect();
                            const clickX = e.clientX - rect.left;
                            if (clickX < rect.width * 0.3) {
                                // 左边30%点击 翻上一页
                                rendition.prev();
                            } else if (clickX > rect.width * 0.7) {
                                // 右边30%点击 翻下一页
                                rendition.next();
                            }
                        };

                        showStatus(
                            "EPUB 加载成功，使用 ← → 键或点击左右翻页",
                            "success"
                        );
                    } catch (error) {
                        console.error("EPUB 加载失败：", error);
                        showStatus("EPUB 加载失败：" + error.message, "error");
                    }
                };

                readerInstance.readAsArrayBuffer(file);
            }

            // 生成目录树
            function generateToc(toc) {
                const tocDiv = document.getElementById("toc");
                if (!tocDiv || !toc) return;

                tocDiv.innerHTML = ""; // 清空旧目录

                const ul = document.createElement("ul");
                ul.id = "toc-list";
                ul.style.listStyle = "none";
                ul.style.paddingLeft = "0";

                function addItems(items, parentUl) {
                    items.forEach((item) => {
                        const li = document.createElement("li");
                        li.style.marginBottom = "6px";

                        const a = document.createElement("a");
                        a.href = "javascript:void(0)";
                        a.textContent = item.label;
                        a.style.color = "inherit";
                        a.style.textDecoration = "none";
                        a.style.cursor = "pointer";

                        a.onclick = () => {
                            if (rendition) {
                                rendition.display(item.href);
                            }
                        };

                        li.appendChild(a);

                        if (item.subitems && item.subitems.length > 0) {
                            const subUl = document.createElement("ul");
                            subUl.style.listStyle = "none";
                            subUl.style.paddingLeft = "15px";
                            addItems(item.subitems, subUl);
                            li.appendChild(subUl);
                        }

                        parentUl.appendChild(li);
                    });
                }

                addItems(toc, ul);
                tocDiv.appendChild(ul);
            }

            function renderToc(toc) {
                const tocList = document.getElementById("toc-list");
                tocList.innerHTML = "";

                toc.forEach((item, index) => {
                    const li = document.createElement("li");
                    li.textContent =
                        item.label || item.text || `章节 ${index + 1}`;
                    li.dataset.href = item.href.split("#")[0];
                    li.style.padding = "6px 8px";
                    li.style.cursor = "pointer";
                    li.style.userSelect = "none";
                    li.title = item.label;

                    li.addEventListener("click", () => {
                        // 高亮当前点击项
                        document
                            .querySelectorAll("#toc-list li")
                            .forEach((el) => {
                                el.classList.remove("active");
                            });
                        li.classList.add("active");

                        // 跳转章节
                        if (rendition && item.href) {
                            rendition.display(item.href);
                            // 跳转章节时滚动右侧容器到顶部
                            const epubViewer =
                                document.getElementById("epub-viewer");
                            if (epubViewer) epubViewer.scrollTop = 0;
                        }
                    });

                    tocList.appendChild(li);
                });
            }

            function setupKeyboardListener() {
                // 给外层绑定
                document.removeEventListener("keydown", onKeyDown);
                document.addEventListener("keydown", onKeyDown);

                // 给iframe内部绑定
                if (!rendition) return;
                rendition.getContents().forEach((contents) => {
                    if (contents && contents.document) {
                        contents.document.removeEventListener(
                            "keydown",
                            onKeyDown
                        );
                        contents.document.addEventListener(
                            "keydown",
                            onKeyDown
                        );
                    }
                });

                // 监听之后，如果后续rendition翻页或章节变了，需要重新绑定iframe内部事件
                rendition.on("rendered", () => {
                            console.log("EPUB内容已渲染，应用自定义样式和事件监听");
                            rendition.getContents().forEach((contents) => {
                                if (contents && contents.document) {
                                    // 添加键盘事件监听
                                    contents.document.removeEventListener(
                                        "keydown",
                                        onKeyDown
                                    );
                                    contents.document.addEventListener(
                                        "keydown",
                                        onKeyDown
                                    );
                                    
                                    // 设置样式
                                    contents.document.documentElement.style.overflowX = "hidden";
                                    contents.document.body.style.overflowX = "hidden";
                                    
                                    // 添加自定义样式表
                                    const styleElement = contents.document.createElement('style');
                                    styleElement.textContent = `
                                        .highlight, .sentence.highlight {
                                            background-color: yellow !important;
                                            color: black !important;
                                        }
                                    `;
                                    contents.document.head.appendChild(styleElement);
                                    
                                    console.log("已向EPUB内容添加自定义样式表");
                                }
                            });
                            
                            const location = rendition.currentLocation();
                            if (location) {
                                rendition.emit("relocated", location);
                            }
                });
            }

            // 键盘翻页事件
            function onKeyDown(e) {
                if (!state.isEpub || !rendition) return;
                if (e.key === "ArrowRight") {
                    e.preventDefault();
                    rendition.next();
                } else if (e.key === "ArrowLeft") {
                    e.preventDefault();
                    rendition.prev();
                } else if (e.key === "Space") {
                    // 空格键控制朗读暂停/继续
                    e.preventDefault();
                    if (state.isSpeaking) {
                        if (mySpeechSynthesis.paused) {
                            resumeReading();
                        } else {
                            pauseReading();
                        }
                    } else {
                        startReading();
                    }
                }
            }

            function applyCurrentSettings() {
                // 统一定义背景色和文字色映射
                const backgroundColorMap = {
                    dark: "#222",
                    sepia: "#f4ecd8",
                    light: "#fefefe",
                };
                const textColorMap = {
                    dark: "#eee",
                    sepia: "#5b4636",
                    light: "#333",
                };

                const bgColor = backgroundColorMap[state.theme] || "#fff";
                const txtColor = textColorMap[state.theme] || "#333";

                // 设置整个页面的背景色和文字颜色
                document.body.style.backgroundColor = bgColor;
                document.body.style.color = txtColor;

                const container = document.querySelector(".container");
                if (container) {
                    container.style.backgroundColor = bgColor;
                    container.style.color = txtColor;
                }

                // 根据当前阅读模式分别应用样式
                if (state.isEpub && rendition && rendition.themes) {
                    applyEpubTheme();
                } else {
                    // 纯文本阅读区域样式
                    const content = reader.querySelector(".content");
                    if (content) {
                        content.style.fontSize = `${state.fontSize}px`;
                        content.style.lineHeight = state.lineHeight;
                        if (state.currentFont) {
                            content.style.fontFamily = `'${state.currentFont}', sans-serif`;
                        }
                    }
                    reader.style.backgroundColor = bgColor;
                    reader.style.color = txtColor;
                }
            }

            function applyEpubTheme() {
                if (!rendition || !rendition.themes) {
                    console.warn("rendition 尚未初始化，无法应用主题");
                    return;
                }

                const style = {
                    body: {
                        "font-size": `${state.fontSize}px`,
                        "line-height": state.lineHeight,
                        background:
                            state.theme === "dark"
                                ? "#222"
                                : state.theme === "sepia"
                                ? "#f4ecd8"
                                : "white",
                        color:
                            state.theme === "dark"
                                ? "#eee"
                                : state.theme === "sepia"
                                ? "#5b4636"
                                : "#333",
                        "font-family": state.currentFont
                            ? `'${state.currentFont}', sans-serif`
                            : "inherit",
                    },
                };

                rendition.themes.register("custom", style);
                rendition.themes.select("custom");
                rendition.themes.override("html, body", {
                    "overflow-x": "hidden",
                    "box-sizing": "border-box",
                    "max-width": "100%",
                });

                rendition.themes.override("body", {
                    "overflow-x": "hidden",
                    "max-width": "100%",
                    "box-sizing": "border-box",
                });

                rendition.themes.override("img", {
                    "max-width": "100%",
                    height: "auto",
                });

                rendition.themes.override(".highlight", {
                    'background-color': 'yellow !important',
                    'color': 'black !important'
                });

                const backgroundColorMap = {
                    dark: "#222",
                    sepia: "#f4ecd8",
                    light: "#fefefe",
                };
                const textColorMap = {
                    dark: "#eee",
                    sepia: "#5b4636",
                    light: "#333",
                };

                const bgColor = backgroundColorMap[state.theme] || "#fff";
                const txtColor = textColorMap[state.theme] || "#333";

                // 设置整个页面的背景色和文字颜色
                document.body.style.backgroundColor = bgColor;
                document.body.style.color = txtColor;

                const container = document.querySelector(".container");
                if (container) {
                    container.style.backgroundColor = bgColor;
                    container.style.color = txtColor;
                }
            }

            async function loadSystemFonts() {
                clearStatus();
                loadFontsBtn.disabled = true;
                loadFontsBtn.textContent = "加载中...";
                try {
                    if (!("queryLocalFonts" in window))
                        throw new Error("浏览器不支持本地字体访问");
                    const fonts = await window.queryLocalFonts();
                    const seen = new Set(),
                        fontList = [];
                    fonts.forEach((f) => {
                        const name = f.fullName || f.postscriptName;
                        if (name && !seen.has(name)) {
                            seen.add(name);
                            fontList.push({ name, value: f.postscriptName });
                        }
                    });
                    fontList.sort((a, b) => a.name.localeCompare(b.name));
                    fontSelector.innerHTML =
                        '<option value="">-- 选择字体 --</option>';
                    fontList.forEach((f) => {
                        const opt = document.createElement("option");
                        opt.value = f.value;
                        opt.textContent = f.name;
                        fontSelector.appendChild(opt);
                    });
                    fontSelector.disabled = false;
                    showStatus(`已加载 ${fontList.length} 种字体`, "success");
                } catch (e) {
                    console.error(e);
                    showStatus("字体加载失败，将提供默认字体选项", "error");
                    [
                        "Arial",
                        "Verdana",
                        "Times New Roman",
                        "Courier New",
                        "宋体",
                        "微软雅黑",
                    ].forEach((f) => {
                        const opt = document.createElement("option");
                        opt.value = f;
                        opt.textContent = f;
                        fontSelector.appendChild(opt);
                    });
                    fontSelector.disabled = false;
                } finally {
                    loadFontsBtn.disabled = false;
                    loadFontsBtn.textContent = "加载系统字体";
                }
            }

            function applySelectedFont(e) {
                const font = e.target.value;
                if (!font) return;
                state.currentFont = font;

                const style = document.getElementById("customFontStyle");
                if (style) style.remove();

                const newStyle = document.createElement("style");
                newStyle.id = "customFontStyle";
                newStyle.textContent = `
                    @font-face { font-family: '${font}'; src: local('${font}'); }
                    #reader .content { font-family: '${font}', sans-serif; }
                `;
                document.head.appendChild(newStyle);

                currentFontDisplay.textContent = font;
                currentFontDisplay.style.fontFamily = `'${font}'`;

                applyCurrentSettings();
                showStatus(`已应用字体: ${font}`, "success");
            }

            function updateFontSize() {
                state.fontSize = fontSizeSlider.value;
                fontSizeValue.textContent = `${state.fontSize}px`;
                applyCurrentSettings();
            }

            function updateLineHeight() {
                state.lineHeight = lineHeightSlider.value;
                lineHeightValue.textContent = state.lineHeight;
                applyCurrentSettings();
            }

            function updateTheme() {
                state.theme = themeSelect.value;
                applyCurrentSettings();
            }

            function applyCurrentSettings() {
                if (state.isEpub && rendition && rendition.themes) {
                    applyEpubTheme();
                } else {
                    // 纯文本调整样式
                    const content = reader.querySelector(".content");
                    if (content) {
                        content.style.fontSize = `${state.fontSize}px`;
                        content.style.lineHeight = state.lineHeight;
                        if (state.currentFont) {
                            content.style.fontFamily = `'${state.currentFont}', sans-serif`;
                        }
                        switch (state.theme) {
                            case "dark":
                                reader.style.backgroundColor = "#222";
                                reader.style.color = "#eee";
                                break;
                            case "sepia":
                                reader.style.backgroundColor = "#f4ecd8";
                                reader.style.color = "#5b4636";
                                break;
                            default:
                                reader.style.backgroundColor = "white";
                                reader.style.color = "#333";
                        }
                    }
                }
            }

            function resetStyles() {
                state.currentFont = null;
                fontSelector.value = "";
                const oldStyle = document.getElementById("customFontStyle");
                if (oldStyle) oldStyle.remove();
                currentFontDisplay.textContent = "未选择字体";
                currentFontDisplay.style.fontFamily = "";
                state.fontSize = 16;
                state.lineHeight = 1.6;
                fontSizeSlider.value = 16;
                lineHeightSlider.value = 1.6;
                fontSizeValue.textContent = "16px";
                lineHeightValue.textContent = "1.6";
                state.theme = "light";
                themeSelect.value = "light";
                applyCurrentSettings();
                showStatus("已重置所有样式", "success");
            }

            function showStatus(msg, type) {
                statusDiv.textContent = msg;
                statusDiv.className = "status " + type;
            }

            function clearStatus() {
                statusDiv.textContent = "";
                statusDiv.className = "status";
            }
            
            // 初始化语音合成
            function initSpeechSynthesis() {
                if (!('speechSynthesis' in window)) {
                    showStatus("您的浏览器不支持语音合成功能", "error");
                    return;
                }
                
                // 获取可用的语音
                const voiceSelect = document.getElementById("voiceSelect");
                voiceSelect.innerHTML = "";
                
                // 加载语音列表
                function loadVoices() {
                    const voices = mySpeechSynthesis.getVoices();
                    if (voices.length === 0) {
                        setTimeout(loadVoices, 100);
                        return;
                    }
                    
                    // 按语言排序
                    voices.sort((a, b) => {
                        return a.lang.localeCompare(b.lang);
                    });
                    
                    // 添加到下拉列表
                    voices.forEach(voice => {
                        const option = document.createElement("option");
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        // 默认选择中文语音
                        if (voice.lang.includes("zh") || voice.lang.includes("cmn")) {
                            option.selected = true;
                        }
                        voiceSelect.appendChild(option);
                    });
                }
                
                // Chrome需要等待voiceschanged事件
                mySpeechSynthesis.addEventListener("voiceschanged", loadVoices);
                loadVoices(); // 初始加载
            }
            
            // 将文本分割成句子
            function splitTextIntoSentences(text) {
                console.log("分割文本成句子，文本长度:", text.length);
                
                if (!text || text.trim().length === 0) {
                    console.error("文本为空，无法分割");
                    return ["无可朗读内容"];
                }
                
                try {
                    // 使用正则表达式分割句子，考虑中英文标点
                    const sentenceRegex = /([.!?。！？…]+\s*)/g;
                    const sentences = text.split(sentenceRegex).filter(s => s.trim().length > 0);
                    
                    console.log("初步分割后的片段数量:", sentences.length);
                    
                    // 合并句子和标点
                    const result = [];
                    for (let i = 0; i < sentences.length; i += 2) {
                        let sentence = sentences[i];
                        if (i + 1 < sentences.length) {
                            sentence += sentences[i + 1];
                        }
                        result.push(sentence);
                    }
                    
                    console.log("最终句子数量:", result.length);
                    
                    // 如果没有成功分割，则将整个文本作为一个句子
                    if (result.length === 0) {
                        console.warn("未能分割出句子，将整个文本作为一个句子");
                        return [text];
                    }
                    
                    return result;
                } catch (error) {
                    console.error("分割句子时出错:", error);
                    return [text]; // 出错时返回原文本作为一个句子
                }
            }
            
            // 开始朗读
            function startReading() {
                console.log("开始朗读函数被调用");
                
                // 检查语音合成API是否可用
                if (!('speechSynthesis' in window)) {
                    console.error("语音合成API不可用");
                    showStatus("您的浏览器不支持语音合成功能", "error");
                    return;
                }
                
                if (state.isSpeaking) {
                    stopReading();
                } else {
                    // 如果不是从朗读状态重新开始，则需要手动清除所有高亮
                    removeAllHighlights();
                }
                
                // 设置朗读状态
                state.isSpeaking = true;
                currentSentenceIndex = 0;
                
                if (state.isEpub) {
                    console.log("开始朗读EPUB内容");
                    startEpubReading();
                } else {
                    console.log("开始朗读纯文本内容");
                    startTextReading();
                }
            }
            
            // 朗读纯文本内容
            function startTextReading() {
                console.log("开始朗读纯文本内容函数被调用");
                console.log("句子数量:", sentences.length);
                
                if (sentences.length === 0) {
                    console.error("没有可朗读的句子");
                    showStatus("没有可朗读的内容", "error");
                    return;
                }
                
                state.isSpeaking = true;
                currentSentenceIndex = 0;
                console.log("开始朗读第一个句子");
                readCurrentSentence();
            }
            
            // 朗读EPUB内容
            function startEpubReading() {
                console.log("开始朗读EPUB内容函数被调用");
                
                if (!rendition) {
                    console.error("EPUB渲染器未初始化");
                    showStatus("EPUB渲染器未初始化", "error");
                    return;
                }
                
                // 获取当前页面内容
                const contents = rendition.getContents();
                if (!contents || contents.length === 0) {
                    console.error("无法获取EPUB内容");
                    showStatus("无法获取EPUB内容", "error");
                    return;
                }
                
                const doc = contents[0].document;
                if (!doc) {
                    console.error("无法获取EPUB文档");
                    showStatus("无法获取EPUB文档", "error");
                    return;
                }
                
                // 获取当前页面文本
                const text = doc.body.textContent;
                console.log("获取到EPUB文本长度:", text.length);
                currentChapterText = text;
                sentences = splitTextIntoSentences(text);
                console.log("EPUB句子数量:", sentences.length);
                currentSentenceIndex = 0;
                
                // 为当前页面的文本节点添加标记，以便高亮
                markTextNodesInEpub(doc);
                
                state.isSpeaking = true;
                console.log("开始朗读EPUB第一个句子");
                readCurrentSentence();
            }
            
            // 标记EPUB中的文本节点
            function markTextNodesInEpub(doc) {
                // 递归遍历所有文本节点
                function walkTextNodes(node, sentences, index) {
                    if (node.nodeType === 3 && node.textContent.trim().length > 0) {
                        // 创建一个span元素包裹文本节点
                        const span = doc.createElement("span");
                        span.className = "sentence";
                        span.dataset.index = index;
                        // 确保span元素可以被正确识别和样式化
                        span.setAttribute("data-sentence", "true");
                        node.parentNode.replaceChild(span, node);
                        span.appendChild(node);
                        return index + 1;
                    } else if (node.nodeType === 1) {
                        // 元素节点，递归处理子节点
                        let currentIndex = index;
                        const childNodes = Array.from(node.childNodes);
                        for (const child of childNodes) {
                            currentIndex = walkTextNodes(child, sentences, currentIndex);
                        }
                        return currentIndex;
                    }
                    return index;
                }
                
                walkTextNodes(doc.body, sentences, 0);
            }
            
            // 朗读当前句子
            function readCurrentSentence() {
                if (currentSentenceIndex >= sentences.length) {
                    // 当前章节朗读完毕
                    if (state.autoNextChapter && state.isEpub) {
                        // 自动朗读下一章
                        setTimeout(() => {
                            rendition.next().then(() => {
                                // 等待页面加载完成
                                setTimeout(() => {
                                    startEpubReading();
                                }, 500);
                            }).catch(() => {
                                // 已经是最后一章
                                stopReading();
                                showStatus("朗读完成", "success");
                            });
                        }, 1000);
                    } else {
                        stopReading();
                        showStatus("朗读完成", "success");
                    }
                    return;
                }
                
                const sentence = sentences[currentSentenceIndex];
                state.currentSentence = sentence;
                
                // 高亮当前句子
                highlightCurrentSentence();
                
                // 创建语音合成实例
                speechUtterance = new SpeechSynthesisUtterance(sentence);
                
                // 设置语音
                const voiceSelect = document.getElementById("voiceSelect");
                const voices = mySpeechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
                if (selectedVoice) {
                    speechUtterance.voice = selectedVoice;
                }
                
                // 设置语速
                const rateRange = document.getElementById("rateRange");
                speechUtterance.rate = parseFloat(rateRange.value);
                
                // 句子结束事件
                speechUtterance.onend = function() {
                    // 移除当前句子的高亮
                    if (state.isEpub) {
                        const contents = rendition.getContents();
                        if (contents && contents.length > 0) {
                            const doc = contents[0].document;
                            if (doc) {
                                const currentElements = doc.querySelectorAll(`.sentence[data-index="${currentSentenceIndex}"]`);
                                currentElements.forEach(el => {
                                    el.classList.remove("highlight");
                                    el.style.backgroundColor = "";
                                    el.style.color = "";
                                });
                            }
                        }
                    } else {
                        const currentElement = document.querySelector(`.sentence[data-index="${currentSentenceIndex}"]`);
                        if (currentElement) {
                            currentElement.classList.remove("highlight");
                            currentElement.style.backgroundColor = "";
                            currentElement.style.color = "";
                        }
                    }
                    
                    // 移动到下一个句子
                    currentSentenceIndex++;
                    readCurrentSentence();
                };
                
                // 开始朗读
                mySpeechSynthesis.speak(speechUtterance);
            }
            
            // 高亮当前句子
            function highlightCurrentSentence() {
                // 不再移除所有高亮，只在句子结束时移除当前句子的高亮
                // 这样可以提高效率，特别是在有大量句子的情况下
                
                if (state.isEpub) {
                    // EPUB模式下高亮
                    const contents = rendition.getContents();
                    if (!contents || contents.length === 0) return;
                    
                    const doc = contents[0].document;
                    if (!doc) return;
                    
                    const sentenceElements = doc.querySelectorAll(`.sentence[data-index="${currentSentenceIndex}"]`);
                    console.log(`EPUB高亮: 找到 ${sentenceElements.length} 个句子元素`);
                    
                    sentenceElements.forEach(el => {
                        // 添加类和内联样式双重保障
                        el.classList.add("highlight");
                        el.style.backgroundColor = "yellow";
                        el.style.color = "black";
                        // 滚动到可视区域
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                    });
                } else {
                    // 纯文本模式下高亮
                    const sentenceElement = document.querySelector(`.sentence[data-index="${currentSentenceIndex}"]`);
                    if (sentenceElement) {
                        // 添加类和内联样式双重保障
                        sentenceElement.classList.add("highlight");
                        sentenceElement.style.backgroundColor = "yellow";
                        sentenceElement.style.color = "black";
                        // 滚动到可视区域
                        sentenceElement.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
            }
            
            // 暂停朗读
            function pauseReading() {
                if (state.isSpeaking) {
                    mySpeechSynthesis.pause();
                    showStatus("朗读已暂停", "success");
                }
            }
            
            // 继续朗读
            function resumeReading() {
                if (state.isSpeaking && mySpeechSynthesis.paused) {
                    mySpeechSynthesis.resume();
                    showStatus("继续朗读", "success");
                }
            }
            
            // 停止朗读
            function stopReading() {
                mySpeechSynthesis.cancel();
                state.isSpeaking = false;
                state.currentSentence = null;
                
                // 移除所有高亮
                removeAllHighlights();
                
                showStatus("朗读已停止", "success");
            }
            
            // 移除所有高亮的辅助函数
            function removeAllHighlights() {
                // 移除纯文本模式下的所有高亮
                const allSentences = document.querySelectorAll(".sentence");
                allSentences.forEach(el => {
                    el.classList.remove("highlight");
                    // 移除内联样式
                    el.style.backgroundColor = "";
                    el.style.color = "";
                });
                
                // 移除EPUB模式下的所有高亮
                if (state.isEpub && rendition) {
                    const contents = rendition.getContents();
                    if (contents && contents.length > 0) {
                        const doc = contents[0].document;
                        if (doc) {
                            const epubSentences = doc.querySelectorAll(".sentence");
                            epubSentences.forEach(el => {
                                el.classList.remove("highlight");
                                el.style.backgroundColor = "";
                                el.style.color = "";
                            });
                        }
                    }
                }
            }
            
            // 更新语速
            function updateSpeechRate() {
                const rateRange = document.getElementById("rateRange");
                const rate = parseFloat(rateRange.value);
                
                if (speechUtterance) {
                    speechUtterance.rate = rate;
                }
                
                // 如果正在朗读，需要重新应用
                if (state.isSpeaking && !mySpeechSynthesis.paused) {
                    const currentIndex = currentSentenceIndex;
                    stopReading();
                    currentSentenceIndex = currentIndex;
                    state.isSpeaking = true;
                    readCurrentSentence();
                }
            }

            init();
        </script>
    </body>
</html>
